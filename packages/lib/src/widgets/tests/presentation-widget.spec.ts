import { afterEach, beforeEach, describe, expect, it, MockInstance, vi } from 'vitest';
import { PresentationWidget } from '@/widgets/presentation-widget';
import { WidgetConfiguration } from '@/interfaces/widget-configuration';
import { PresentationService } from '@/services/presentation.service';
import { Presentation } from '@/interfaces/presentation';

vi.mock('@/services/presentation.service');

describe('PresentationWidget', () => {
  const mockConfiguration: WidgetConfiguration = {
    guid: 'test-guid',
    host: 'example.com',
    selector: '.widget-container',
    widgetOptions: {
      playbackMode: 'inline',
    },
  };

  const mockPresentation: Presentation = {
    guid: 'test-guid',
    player: 'https://example.com/player',
    thumbnail: {
      autoGenerated: false,
      cdnUrl: 'https://example.com/thumbnail.jpg',
      height: 200,
      url: 'https://example.com/thumbnail.jpg',
      width: 300,
    },
    title: 'Test Presentation',
  };

  let container: HTMLElement;
  let getPresentationMock: MockInstance;

  beforeEach(() => {
    const div = document.createElement('div');

    div.classList.add('widget-container');
    document.body.appendChild(div);

    container = div;

    getPresentationMock = vi.spyOn(PresentationService.prototype, 'getPresentation')
      .mockResolvedValue(mockPresentation);

    // hide console.error from the widget
    console.error = vi.fn();
  });

  afterEach(() => {
    document.body.innerHTML = '';

    vi.restoreAllMocks();
    vi.clearAllMocks();
  });

  const flushPromises = () => new Promise(setImmediate);

  describe('constructor', () => {
    it('should initialize widget', async () => {
      const widget = await PresentationWidget.create(mockConfiguration);

      expect(widget).toBeDefined();
    });

    it('should validate the configuration and throw an error', async () => {
      const invalidConfig = {
        ...mockConfiguration,
        host: '   ',
      };

      await expect(() => PresentationWidget.create(invalidConfig)).rejects.toThrow('`host` cannot be an empty string');
    });
  });

  describe('init', () => {
    it('should fetch presentation and mount component', async () => {
      const querySelectorSpy = vi.spyOn(document, 'querySelector');

      await PresentationWidget.create(mockConfiguration);

      await flushPromises();

      expect(getPresentationMock).toHaveBeenCalledWith(
        'test-guid',
        'example.com',
      );

      expect(querySelectorSpy).toHaveBeenCalledWith('.widget-container');
      expect(container.innerHTML)
        .toMatchInlineSnapshot(`"<div class="qc-widget qc-presentation-widget"><button type="button" style="place-items: center center;" class="qc-thumbnail"><img src="https://example.com/thumbnail.jpg" alt="Thumbnail for Test Presentation" class="qc-thumbnail__image"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" fill="currentColor" width="44" height="44" aria-hidden="true" class="qc-icon qc-thumbnail__play-button qc-thumbnail__play-button--default"><path d="M22.643 17.734a1 1 0 000-1.696L12.417 9.647a1 1 0 00-1.53.848v12.783a1 1 0 001.53.848l10.226-6.392zm-9.166 8.088a3 3 0 01-4.59-2.544V10.495a3 3 0 014.59-2.544l10.226 6.391a3 3 0 010 5.088l-10.226 6.392z"></path></svg></button></div>"`);
    });

    it('throws error when container element is not found', async () => {
      vi.spyOn(document, 'querySelector').mockReturnValue(null);

      await expect(async () => await PresentationWidget.create(mockConfiguration)).rejects.toThrow('Element for selector ".widget-container" not found');
    });
  });

  describe('mount', () => {
    it('renders widget with presentation title and player component', async () => {
      await PresentationWidget.create(mockConfiguration);

      await flushPromises();

      expect(container.innerHTML)
        .toMatchInlineSnapshot(`"<div class="qc-widget qc-presentation-widget"><button type="button" style="place-items: center center;" class="qc-thumbnail"><img src="https://example.com/thumbnail.jpg" alt="Thumbnail for Test Presentation" class="qc-thumbnail__image"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" fill="currentColor" width="44" height="44" aria-hidden="true" class="qc-icon qc-thumbnail__play-button qc-thumbnail__play-button--default"><path d="M22.643 17.734a1 1 0 000-1.696L12.417 9.647a1 1 0 00-1.53.848v12.783a1 1 0 001.53.848l10.226-6.392zm-9.166 8.088a3 3 0 01-4.59-2.544V10.495a3 3 0 014.59-2.544l10.226 6.391a3 3 0 010 5.088l-10.226 6.392z"></path></svg></button></div>"`);
    });

    it('renders widget with not found message', async () => {
      getPresentationMock.mockRejectedValue(new Error('Presentation not found'));

      await PresentationWidget.create(mockConfiguration);

      await flushPromises();

      expect(container.innerHTML)
        .toMatchInlineSnapshot(`"<div style="aspect-ratio: 16 / 9;" class="qc-widget qc-presentation-widget"><div class="qc-not-found"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256" fill="currentColor" aria-hidden="true" width="48" height="48" class="qc-icon"><path d="M216,40H40A16,16,0,0,0,24,56V200a16,16,0,0,0,16,16h64a8,8,0,0,0,7.59-5.47l14.83-44.48L163,151.43a8.07,8.07,0,0,0,4.46-4.46l14.62-36.55,44.48-14.83A8,8,0,0,0,232,88V56A16,16,0,0,0,216,40ZM112.41,157.47,98.23,200H40V172l52-52,30.42,30.42L117,152.57A8,8,0,0,0,112.41,157.47ZM216,82.23,173.47,96.41a8,8,0,0,0-4.9,4.62l-14.72,36.82L138.58,144l-35.27-35.27a16,16,0,0,0-22.62,0L40,149.37V56H216Zm12.68,33a8,8,0,0,0-7.21-1.1l-23.8,7.94a8,8,0,0,0-4.9,4.61l-14.31,35.77-35.77,14.31a8,8,0,0,0-4.61,4.9l-7.94,23.8A8,8,0,0,0,137.73,216H216a16,16,0,0,0,16-16V121.73A8,8,0,0,0,228.68,115.24ZM216,200H148.83l3.25-9.75,35.51-14.2a8.07,8.07,0,0,0,4.46-4.46l14.2-35.51,9.75-3.25Z"></path></svg><div>Presentation not found</div></div></div>"`);
    });

    it('uses HTMLElement from selector if provided', async () => {
      const querySelectorSpy = vi.spyOn(document, 'querySelector');
      const element = document.createElement('div');

      document.body.appendChild(element);

      const configWithHTMLElement: WidgetConfiguration = {
        ...mockConfiguration,
        selector: element,
      };

      await PresentationWidget.create(configWithHTMLElement);

      await flushPromises();

      expect(querySelectorSpy).not.toHaveBeenCalled();
      expect(element.innerHTML)
        .toMatchInlineSnapshot(`"<div class="qc-widget qc-presentation-widget"><button type="button" style="place-items: center center;" class="qc-thumbnail"><img src="https://example.com/thumbnail.jpg" alt="Thumbnail for Test Presentation" class="qc-thumbnail__image"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" fill="currentColor" width="44" height="44" aria-hidden="true" class="qc-icon qc-thumbnail__play-button qc-thumbnail__play-button--default"><path d="M22.643 17.734a1 1 0 000-1.696L12.417 9.647a1 1 0 00-1.53.848v12.783a1 1 0 001.53.848l10.226-6.392zm-9.166 8.088a3 3 0 01-4.59-2.544V10.495a3 3 0 014.59-2.544l10.226 6.391a3 3 0 010 5.088l-10.226 6.392z"></path></svg></button></div>"`);
    });

    it('clears container innerHTML before mounting', async () => {
      const newDiv = document.createElement('div');

      newDiv.innerHTML = 'existing content';
      container.appendChild(newDiv);

      expect(container.innerHTML).toMatchInlineSnapshot(`"<div>existing content</div>"`);

      await PresentationWidget.create(mockConfiguration);

      // Wait for async init to complete
      await flushPromises();

      expect(container.innerHTML)
        .toMatchInlineSnapshot(`"<div class="qc-widget qc-presentation-widget"><button type="button" style="place-items: center center;" class="qc-thumbnail"><img src="https://example.com/thumbnail.jpg" alt="Thumbnail for Test Presentation" class="qc-thumbnail__image"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" fill="currentColor" width="44" height="44" aria-hidden="true" class="qc-icon qc-thumbnail__play-button qc-thumbnail__play-button--default"><path d="M22.643 17.734a1 1 0 000-1.696L12.417 9.647a1 1 0 00-1.53.848v12.783a1 1 0 001.53.848l10.226-6.392zm-9.166 8.088a3 3 0 01-4.59-2.544V10.495a3 3 0 014.59-2.544l10.226 6.391a3 3 0 010 5.088l-10.226 6.392z"></path></svg></button></div>"`);
    });

    it('should render DialogComponent when playbackMode is modal', async () => {
      const modalConfiguration: WidgetConfiguration = {
        ...mockConfiguration,
        widgetOptions: {
          ...mockConfiguration.widgetOptions,
          playbackMode: 'modal',
        },
      };

      await PresentationWidget.create(modalConfiguration);

      await flushPromises();

      expect(container.querySelector('.qc-dialog')).not.toBeNull();
    });

    it('should render PlayerComponent when playbackMode is not modal', async () => {
      const nonModalConfiguration: WidgetConfiguration = {
        ...mockConfiguration,
        widgetOptions: {
          ...mockConfiguration.widgetOptions,
          playbackMode: 'inline',
        },
      };

      await PresentationWidget.create(nonModalConfiguration);

      await flushPromises();

      expect(container.querySelector('.qc-dialog')).toBeNull();
      expect(container.querySelector('.qc-thumbnail')).not.toBeNull();
    });

    it('should render PlayerComponent when playbackMode is undefined', async () => {
      const configWithoutPlaybackMode: WidgetConfiguration = {
        ...mockConfiguration,
        widgetOptions: {
          ...mockConfiguration.widgetOptions,
          playbackMode: undefined,
        },
      };

      await PresentationWidget.create(configWithoutPlaybackMode);

      await flushPromises();

      expect(container.querySelector('.qc-dialog')).toBeNull();
      expect(container.querySelector('.qc-thumbnail')).not.toBeNull();
    });
  });

  describe('destroy', () => {
    it('destroy the widget and clean up the DOM', async () => {
      const widget = await PresentationWidget.create(mockConfiguration);

      await flushPromises();

      expect(container.innerHTML)
        .toMatchInlineSnapshot(`"<div class="qc-widget qc-presentation-widget"><button type="button" style="place-items: center center;" class="qc-thumbnail"><img src="https://example.com/thumbnail.jpg" alt="Thumbnail for Test Presentation" class="qc-thumbnail__image"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" fill="currentColor" width="44" height="44" aria-hidden="true" class="qc-icon qc-thumbnail__play-button qc-thumbnail__play-button--default"><path d="M22.643 17.734a1 1 0 000-1.696L12.417 9.647a1 1 0 00-1.53.848v12.783a1 1 0 001.53.848l10.226-6.392zm-9.166 8.088a3 3 0 01-4.59-2.544V10.495a3 3 0 014.59-2.544l10.226 6.391a3 3 0 010 5.088l-10.226 6.392z"></path></svg></button></div>"`);

      widget.destroy();

      await flushPromises();

      expect(container.innerHTML).toMatchInlineSnapshot(`""`);
    });
  });
});
